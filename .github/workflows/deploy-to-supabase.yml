name: Deploy Accountability System to Supabase

on:
  workflow_dispatch:
  push:
    paths:
      - 'schemas/**'
      - '.github/workflows/deploy-to-supabase.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Prepare SQL schemas
        run: |
          echo "üì¶ Preparing schemas..."
          
          # The files are Base64 encoded, decode them
          if [ -f "schemas/active_tasks_schema.sql" ]; then
            base64 -d schemas/active_tasks_schema.sql > active_tasks.sql || cp schemas/active_tasks_schema.sql active_tasks.sql
            echo "‚úÖ Active tasks schema prepared"
          fi
          
          if [ -f "schemas/multiplier_schema_update.sql" ]; then
            base64 -d schemas/multiplier_schema_update.sql > multiplier.sql || cp schemas/multiplier_schema_update.sql multiplier.sql
            echo "‚úÖ Multiplier schema prepared"
          fi
          
          # Merge into single file
          cat active_tasks.sql > merged_schema.sql
          echo "" >> merged_schema.sql
          cat multiplier.sql >> merged_schema.sql
          
          echo "üìä Merged schema stats:"
          wc -l merged_schema.sql
          head -20 merged_schema.sql
      
      - name: Deploy to Supabase
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "üöÄ Deploying to Supabase..."
          
          PGPASSWORD="$DB_PASSWORD" psql \
            -h aws-0-us-east-1.pooler.supabase.com \
            -p 6543 \
            -U postgres.mocerqjnksmhcjzxrewo \
            -d postgres \
            -f merged_schema.sql
          
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "‚úÖ Deployment successful"
          else
            echo "‚ùå Deployment failed with exit code $exit_code"
            exit $exit_code
          fi
      
      - name: Verify deployment
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "üîç Verifying deployment..."
          
          PGPASSWORD="$DB_PASSWORD" psql \
            -h aws-0-us-east-1.pooler.supabase.com \
            -p 6543 \
            -U postgres.mocerqjnksmhcjzxrewo \
            -d postgres \
            -c "SELECT COUNT(*) as permission_stage_column FROM information_schema.columns WHERE table_name = 'active_tasks' AND column_name = 'permission_stage';"
          
          echo "‚úÖ Verification complete"
